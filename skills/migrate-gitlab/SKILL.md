---
name: migrate-gitlab
description: Automated migration tool for Go projects moving from gitlab.meitu.com to git.meitu.com. Scans dependencies, updates import paths for the current module only, modifies CI configuration, and manages go.mod replace directives.
license: Apache-2.0
metadata:
  author: vjoke
  repository: https://github.com/vjoke/lgh
  version: "1.0.0"
  tags: go, gitlab, migration, meitu, automation, dependencies
---

# GitLab to Git Migration Tool

This skill automates the migration of Go projects from `gitlab.meitu.com` to `git.meitu.com`.

## Overview

When migrating a Go project, the following changes are required:

1. **go.mod**: Update module path and add replace directives for dependencies
2. **go.sum**: Remove (will be regenerated)
3. **.gitlab-ci.yml**: Update CI configuration variables
4. **Source files**: Update import paths for the current module only

## Migration Steps

### Step 1: Analyze Current Project

First, identify the current module and its dependencies:

```bash
# Get current module path
MODULE_PATH=$(grep "^module" go.mod | awk '{print $2}')
echo "Current module: $MODULE_PATH"

# Find all gitlab.meitu.com dependencies
echo "Dependencies to replace:"
grep "gitlab.meitu.com" go.mod | grep -v "^module"

# Find Go files with current module imports
echo "Files with current module imports:"
grep -r "$MODULE_PATH" --include="*.go" . | grep -v "vendor/"
```

### Step 2: Update go.mod

Replace the module declaration and add replace directives:

```bash
# Update module path
sed -i '' 's|gitlab.meitu.com/|git.meitu.com/|g' go.mod

# Add replace directives for all gitlab.meitu.com dependencies
# Get all gitlab.meitu.com require lines and convert to replace directives
grep -E "^\s+gitlab\.meitu\.com" go.mod | \
  sed -E 's/^[[:space:]]+(gitlab\.meitu\.com\/[^[:space:]]+)[[:space:]]+(v[0-9]+\.[0-9]+\.[0-9]+[^[:space:]]*).*/replace \1 => git.meitu.com\/\1 \2/' >> go.mod
```

**Example go.mod changes:**

Before:
```go
module gitlab.meitu.com/platform/goboot

go 1.21

require (
    gitlab.meitu.com/pl_container/mlib v1.32.26
    gitlab.meitu.com/gocommons/cores v0.0.5
)
```

After:
```go
module git.meitu.com/platform/goboot

go 1.21

require (
    gitlab.meitu.com/pl_container/mlib v1.32.26
    gitlab.meitu.com/gocommons/cores v0.0.5
)

replace (
    gitlab.meitu.com/pl_container/mlib => git.meitu.com/pl_container/mlib v1.32.26
    gitlab.meitu.com/gocommons/cores => git.meitu.com/gocommons/cores v0.0.5
)
```

### Step 3: Remove go.sum

```bash
rm go.sum
```

The go.sum file will be regenerated by `go mod tidy` with new hashes.

### Step 4: Update .gitlab-ci.yml

Update CI configuration:

```bash
# Update SRC_PATH and CWD
sed -i '' 's|gitlab.meitu.com/|git.meitu.com/|g' .gitlab-ci.yml

# Update GOPRIVATE to include both domains
sed -i '' 's|GOPRIVATE=.*|GOPRIVATE=git.meitu.com,gitlab.meitu.com|g' .gitlab-ci.yml
```

**Example .gitlab-ci.yml changes:**

Before:
```yaml
variables:
  SRC_PATH: gitlab.meitu.com/platform/goboot
  CWD: /builds/gitlab.meitu.com/platform/goboot
  GOPRIVATE: gitlab.meitu.com

before_script:
  - git config --global url."https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.meitu.com/".insteadOf "https://gitlab.meitu.com/"
```

After:
```yaml
variables:
  SRC_PATH: git.meitu.com/platform/goboot
  CWD: /builds/git.meitu.com/platform/goboot
  GOPRIVATE: git.meitu.com,gitlab.meitu.com

before_script:
  - git config --global url."https://gitlab-ci-token:${CI_JOB_TOKEN}@git.meitu.com/".insteadOf "https://git.meitu.com/"
  - git config --global url."https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.meitu.com/".insteadOf "https://gitlab.meitu.com/"
```

### Step 5: Update Source Imports (Current Module Only)

**Important**: Only update imports that belong to the current module. External dependencies (like `gitlab.meitu.com/pl_container/mlib`) should remain unchanged in source files - they will be resolved via replace directives.

```bash
# Get the old module path (before migration)
OLD_MODULE="gitlab.meitu.com/platform/goboot"  # Replace with your actual module
NEW_MODULE="git.meitu.com/platform/goboot"

# Update only imports that start with the current module path
# This updates internal imports but leaves external dependencies unchanged
find . -name "*.go" -type f ! -path "./vendor/*" -exec \
  sed -i '' "s|\"$OLD_MODULE/|\"$NEW_MODULE/|g" {} \;
```

**Example import changes:**

Before:
```go
import (
    "gitlab.meitu.com/platform/goboot/config"
    "gitlab.meitu.com/platform/goboot/utils"
    "gitlab.meitu.com/pl_container/mlib/client"
)
```

After:
```go
import (
    "git.meitu.com/platform/goboot/config"
    "git.meitu.com/platform/goboot/utils"
    "gitlab.meitu.com/pl_container/mlib/client"  // Unchanged - resolved via replace
)
```

### Step 6: Verify Migration

```bash
# Download dependencies and regenerate go.sum
go mod tidy

# Verify build
go build ./...

# Run tests
go test ./...
```

## Complete Migration Script

```bash
#!/bin/bash
set -e

# Configuration
OLD_DOMAIN="gitlab.meitu.com"
NEW_DOMAIN="git.meitu.com"

# Get current module path
MODULE_PATH=$(grep "^module" go.mod | awk '{print $2}')
OLD_MODULE="$MODULE_PATH"
NEW_MODULE=$(echo "$MODULE_PATH" | sed "s|$OLD_DOMAIN|$NEW_DOMAIN|")

echo "Migrating: $OLD_MODULE -> $NEW_MODULE"

# Step 1: Update go.mod module declaration
sed -i '' "s|^module $OLD_DOMAIN/|module $NEW_DOMAIN/|" go.mod

# Step 2: Add replace directives for gitlab.meitu.com dependencies
echo "" >> go.mod
echo "replace (" >> go.mod

# Extract gitlab.meitu.com dependencies and create replace directives
grep -E "^\s+$OLD_DOMAIN" go.mod | while read -r line; do
    DEP=$(echo "$line" | awk '{print $1}')
    VERSION=$(echo "$line" | awk '{print $2}')
    NEW_DEP=$(echo "$DEP" | sed "s|$OLD_DOMAIN|$NEW_DOMAIN|")
    echo "    $DEP => $NEW_DEP $VERSION" >> go.mod
done

echo ")" >> go.mod

# Step 3: Remove go.sum
rm -f go.sum

# Step 4: Update .gitlab-ci.yml if exists
if [ -f ".gitlab-ci.yml" ]; then
    sed -i '' "s|$OLD_DOMAIN/|$NEW_DOMAIN/|g" .gitlab-ci.yml
    sed -i '' "s|GOPRIVATE=.*|GOPRIVATE=$NEW_DOMAIN,$OLD_DOMAIN|g" .gitlab-ci.yml
fi

# Step 5: Update source imports (current module only)
find . -name "*.go" -type f ! -path "./vendor/*" -exec \
    sed -i '' "s|\"$OLD_MODULE/|\"$NEW_MODULE/|g" {} \;

# Step 6: Verify
echo "Running go mod tidy..."
go mod tidy

echo "Migration complete!"
```

## Troubleshooting

### Issue: go mod tidy fails with "unknown revision"

**Cause**: The new git.meitu.com repository may not exist or be accessible.

**Solution**:
1. Ensure the repository has been mirrored to git.meitu.com
2. Check authentication credentials
3. Update GOPRIVATE to include both domains

### Issue: Import path not found

**Cause**: Import paths for external dependencies were incorrectly modified.

**Solution**: Only update imports that start with the current module path. External dependencies should use replace directives.

### Issue: CI build fails

**Cause**: CI configuration not properly updated.

**Solution**: Verify:
- SRC_PATH points to new domain
- GOPRIVATE includes both domains
- Git config has credentials for both domains

## When to Use This Skill

Use this skill when:
- Migrating a Go project from gitlab.meitu.com to git.meitu.com
- Setting up replace directives for gitlab.meitu.com dependencies
- Updating CI configuration for the new domain
- Need to automate the migration process

## Key Points

1. **Replace directives** handle external dependencies - their import paths in source code stay as `gitlab.meitu.com/...`
2. **Current module imports** are updated to use `git.meitu.com/...`
3. **go.sum is regenerated** - don't try to preserve it
4. **Both domains in GOPRIVATE** - ensures go mod can access both old and new repositories during transition
